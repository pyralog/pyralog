graph TB
    subgraph "Application Layer"
        APP[Application]
        BATUTA[üéº Batuta Language]
        QUERY[Query Engine]
    end
    
    subgraph "üî∫ Pyramid Nodes - Pyralog Cluster"
        PYRAMID_RAFT[Raft Consensus<br/>Per Partition]
        PYRAMID_STORAGE[LSM Storage<br/>Segments & Indexes]
        PARTITION[Partition Assignment<br/>Consistent Hashing]
        MEMBERSHIP[Cluster Membership<br/>Gossip Protocol]
    end
    
    subgraph "üóø Obelisk Nodes - ‚òÄÔ∏è Pharaoh Network"
        OBELISK[Obelisk Nodes<br/>Crash-Safe Counters]
        OBELISK_SPARSE[Sparse Files<br/>Counter Storage]
        PHARAOH[Pharaoh Network<br/>Coordination Layer]
        SCARAB[ü™≤ Scarab IDs<br/>Unique Identifiers]
    end
    
    subgraph "Pyramid Storage Layer"
        LSM[LSM Tree]
        SEGMENTS[Segments]
        INDEX[Indexes]
        PPHM[PPHM Indexes]
        TIERED[Tiered Storage<br/>S3/GCS/Azure]
    end
    
    subgraph "Consensus & Replication"
        RAFT[Raft Consensus]
        QUORUM[Flexible Quorums]
        COPYSET[CopySet Replication]
    end
    
    subgraph "Actor System"
        ACTORS[Location-Transparent Actors]
        SUPERVISION[Supervision Trees]
        TOPOLOGY[Topology-Level Reactivity]
    end
    
    %% Application to Pyramid
    APP --> BATUTA
    BATUTA --> QUERY
    QUERY --> PYRAMID_RAFT
    QUERY --> PYRAMID_STORAGE
    
    %% Partition and membership
    QUERY --> PARTITION
    QUERY --> MEMBERSHIP
    
    %% Pyramid internals
    PYRAMID_RAFT --> LSM
    PYRAMID_STORAGE --> LSM
    
    %% Pyramid requests IDs from Pharaoh Network
    QUERY -->|Request IDs| OBELISK
    OBELISK --> OBELISK_SPARSE
    OBELISK_SPARSE -->|Generate| SCARAB
    
    %% Partition assignment
    PARTITION --> SCARAB
    
    %% Storage internals
    LSM --> SEGMENTS
    LSM --> INDEX
    LSM --> PPHM
    SEGMENTS --> TIERED
    
    %% Consensus
    RAFT --> QUORUM
    QUORUM --> COPYSET
    PYRAMID_RAFT --> RAFT
    
    %% Actor integration
    QUERY --> ACTORS
    ACTORS --> SUPERVISION
    SUPERVISION --> TOPOLOGY
    TOPOLOGY --> PYRAMID_RAFT
    
    %% Styling
    classDef primitive fill:#4A90E2,stroke:#2E5C8A,color:#fff
    classDef obelisk_storage fill:#8B4513,stroke:#5D2E0C,color:#fff
    classDef pyramid_storage fill:#7CB342,stroke:#558B2F,color:#fff
    classDef consensus fill:#F57C00,stroke:#E65100,color:#fff
    classDef application fill:#9C27B0,stroke:#6A1B9A,color:#fff
    classDef coordination fill:#FFD700,stroke:#FFA000,color:#000
    
    class OBELISK,PHARAOH,SCARAB primitive
    class OBELISK_SPARSE obelisk_storage
    class LSM,SEGMENTS,INDEX,PPHM,TIERED,PYRAMID_STORAGE,PYRAMID_RAFT pyramid_storage
    class RAFT,QUORUM,COPYSET consensus
    class APP,BATUTA,QUERY,ACTORS,SUPERVISION,TOPOLOGY application
    class PARTITION,MEMBERSHIP coordination

